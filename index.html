<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Voice Cash</title>

<style>
:root{
  --bg:#0f0f14;--card:#1a1a26;--accent:#7c5cff;--danger:#ff4d4d;--text:#fff;--muted:#9a9ab3;
  --ok:#22c55e;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,BlinkMacSystemFont}
.app{max-width:520px;margin:auto;padding:16px 14px 22px}
h1{margin:8px 0 10px;text-align:center;font-size:22px}
small{color:var(--muted)}
a{color:var(--accent)}
.hidden{display:none}

.topbar{
  display:flex;gap:10px;margin:10px 0 12px
}
.topbar button{
  flex:1;padding:12px 10px;border-radius:14px;border:1px solid rgba(255,255,255,.08);
  background:var(--card);color:var(--text);font-size:14px
}
.topbar button.active{
  border-color:rgba(124,92,255,.7);
  box-shadow:0 0 0 2px rgba(124,92,255,.15) inset;
}
.row{display:flex;gap:10px;margin:10px 0 12px}
.card{
  flex:1;background:var(--card);border-radius:14px;padding:12px;
}
.card .label{color:var(--muted);font-size:13px}
.card .value{color:var(--accent);font-size:20px;margin-top:6px}

button.primary{
  width:100%;padding:16px;border-radius:16px;border:none;background:var(--accent);color:#fff;font-size:18px
}
button.primary.recording{background:var(--danger);animation:pulse 1.2s infinite}
@keyframes pulse{
  0%{box-shadow:0 0 0 0 rgba(255,77,77,.55)}
  70%{box-shadow:0 0 0 16px rgba(255,77,77,0)}
  100%{box-shadow:0 0 0 0 rgba(255,77,77,0)}
}

.status{
  text-align:center;color:var(--muted);margin:10px 0 6px;min-height:20px
}

.sectionTitle{
  display:flex;align-items:center;justify-content:space-between;
  margin:10px 0 8px;color:var(--accent);font-weight:600
}
.pills{display:flex;gap:8px}
.pills button{
  padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.10);
  background:transparent;color:var(--text);font-size:13px
}
.pills button.active{
  background:rgba(124,92,255,.16);
  border-color:rgba(124,92,255,.45);
}

.dayHeader{
  display:flex;justify-content:space-between;align-items:flex-end;
  margin:10px 0 6px;color:var(--accent);font-weight:600
}
.dayHeader .sub{color:var(--muted);font-weight:400;font-size:12px}

.record{
  background:var(--card);border-radius:12px;padding:10px 10px;margin:8px 0;
  display:flex;justify-content:space-between;gap:10px
}
.record .left{min-width:0}
.record .item{font-size:15px;word-break:break-word}
.record .meta{color:var(--muted);font-size:12px;margin-top:3px}
.record .right{display:flex;align-items:center;gap:8px}
.record .amt{font-size:16px}
.iconBtn{
  width:34px;height:34px;border-radius:10px;border:1px solid rgba(255,255,255,.10);
  background:transparent;color:var(--text);font-size:16px;display:inline-flex;align-items:center;justify-content:center
}
.iconBtn.danger{border-color:rgba(255,77,77,.35)}
.iconBtn.ok{border-color:rgba(34,197,94,.35)}
.iconBtn:active{transform:scale(.98)}

.navLine{
  display:flex;gap:10px;margin:10px 0 6px
}
.navLine button{
  flex:1;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.10);
  background:transparent;color:var(--text)
}

.chartWrap{
  background:rgba(255,255,255,.03);
  border:1px solid rgba(255,255,255,.06);
  border-radius:14px;padding:12px;margin-top:10px
}
.chart{
  display:flex;align-items:flex-end;gap:6px;height:170px;
  overflow-x:auto;padding:6px 4px 18px
}
.col{
  flex:0 0 16px;border-radius:7px;background:rgba(124,92,255,.75);
  position:relative;cursor:pointer
}
.col.zero{background:rgba(255,255,255,.12)}
.col:hover{opacity:.95}
.colLabel{
  position:absolute;bottom:-18px;left:50%;transform:translateX(-50%);
  font-size:10px;color:var(--muted);white-space:nowrap
}
.colSum{
  position:absolute;top:-18px;left:50%;transform:translateX(-50%);
  font-size:10px;color:#fff;white-space:nowrap
}

.bars{display:flex;flex-direction:column;gap:8px;margin-top:10px}
.barRow{
  background:rgba(255,255,255,.03);
  border:1px solid rgba(255,255,255,.06);
  border-radius:12px;padding:10px;cursor:pointer
}
.barTop{display:flex;justify-content:space-between;gap:10px}
.barTop .name{font-weight:600}
.barTop .nums{color:var(--muted)}
.barTrack{
  height:10px;border-radius:999px;background:rgba(255,255,255,.08);
  margin-top:8px;overflow:hidden
}
.barFill{
  height:100%;background:rgba(124,92,255,.80);
  width:0%
}
.badge{
  display:inline-block;padding:3px 8px;border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  color:var(--muted);font-size:12px
}

.modalBack{
  position:fixed;inset:0;background:rgba(0,0,0,.55);
  display:flex;align-items:flex-end;justify-content:center;padding:14px;
}
.modal{
  width:min(520px,100%);
  background:var(--card);
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;
  padding:14px;
}
.modal h3{margin:4px 0 10px}
.field{
  margin:10px 0
}
.field label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
.field input{
  width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.04);color:var(--text);font-size:16px
}
.modalActions{display:flex;gap:10px;margin-top:12px}
.modalActions button{
  flex:1;padding:12px;border-radius:14px;border:none;font-size:15px
}
.modalActions .save{background:var(--ok);color:#08120b}
.modalActions .cancel{background:rgba(255,255,255,.10);color:var(--text)}
.modalActions .del{background:var(--danger);color:#fff}
</style>
</head>

<body>
<div class="app">
  <h1>üéô Voice Cash</h1>

  <!-- 3 –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ -->
  <div class="topbar">
    <button id="btnDay" class="active">–¢—Ä–∞—Ç—ã –∑–∞ –¥–µ–Ω—å</button>
    <button id="btnMonth">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –º–µ—Å—è—Ü</button>
    <button id="btnYear">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –≥–æ–¥</button>
  </div>

  <!-- –°–≤–æ–¥–∫–∞ -->
  <div class="row">
    <div class="card">
      <div class="label">–°–µ–≥–æ–¥–Ω—è</div>
      <div class="value" id="sumToday">0</div>
    </div>
    <div class="card">
      <div class="label">–≠—Ç–æ—Ç –º–µ—Å—è—Ü</div>
      <div class="value" id="sumMonth">0</div>
    </div>
    <div class="card">
      <div class="label">–≠—Ç–æ—Ç –≥–æ–¥</div>
      <div class="value" id="sumYear">0</div>
    </div>
  </div>

  <!-- –ì–æ–ª–æ—Å -->
  <button id="recBtn" class="primary">üé§ –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
  <div class="status" id="status"></div>

  <!-- DAY VIEW -->
  <div id="viewDay">
    <div class="sectionTitle">
      <div>
        <span id="dayTitle">–°–µ–≥–æ–¥–Ω—è</span>
        <div class="sub" id="daySub"></div>
      </div>
      <span class="badge" id="dayTotalBadge">0</span>
    </div>

    <div class="navLine">
      <button id="prevDay">‚Üê –î–µ–Ω—å</button>
      <button id="toToday">–°–µ–≥–æ–¥–Ω—è</button>
      <button id="nextDay">–î–µ–Ω—å ‚Üí</button>
    </div>

    <div id="dayList"></div>
  </div>

  <!-- MONTH VIEW -->
  <div id="viewMonth" class="hidden">
    <div class="sectionTitle">
      <div>
        <span id="monthTitle">–ú–µ—Å—è—Ü</span>
        <div class="sub" id="monthSub"></div>
      </div>
      <span class="badge" id="monthTotalBadge">0</span>
    </div>

    <div class="navLine">
      <button id="prevMonth">‚Üê –ú–µ—Å—è—Ü</button>
      <button id="monthToNow">–¢–µ–∫—É—â–∏–π</button>
      <button id="nextMonth">–ú–µ—Å—è—Ü ‚Üí</button>
    </div>

    <div class="pills">
      <button id="pillMonthDays" class="active">–î–Ω–∏</button>
      <button id="pillMonthCats">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
    </div>

    <div id="monthDaysPanel">
      <div class="chartWrap">
        <div class="chart" id="monthChart"></div>
      </div>
      <small>–¢–∞–ø –ø–æ —Å—Ç–æ–ª–±–∏–∫—É ‚Üí –æ—Ç–∫—Ä–æ–µ—Ç—Å—è ‚Äú–¢—Ä–∞—Ç—ã –∑–∞ –¥–µ–Ω—å‚Äù –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É.</small>
    </div>

    <div id="monthCatsPanel" class="hidden">
      <div class="bars" id="monthCats"></div>
      <small>–¢–∞–ø –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Üí –ø–æ–∫–∞–∂–µ–º –¥–Ω–∏ (–≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ) —Ç–æ–ª—å–∫–æ –ø–æ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.</small>
    </div>

    <div id="monthCatDaysPanel" class="hidden">
      <div class="sectionTitle">
        <div>–ö–∞—Ç–µ–≥–æ—Ä–∏—è: <span id="monthCatName"></span></div>
        <button class="iconBtn" id="closeMonthCatDays" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      </div>
      <div class="chartWrap">
        <div class="chart" id="monthCatChart"></div>
      </div>
      <small>–¢–∞–ø –ø–æ –¥–Ω—é ‚Üí –æ—Ç–∫—Ä–æ–µ—Ç—Å—è ‚Äú–¢—Ä–∞—Ç—ã –∑–∞ –¥–µ–Ω—å‚Äù (—Ñ–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω, –Ω–æ —Å–ø–∏—Å–æ–∫ ‚Äî –≤—Å–µ —Ç—Ä–∞—Ç—ã –¥–Ω—è).</small>
    </div>
  </div>

  <!-- YEAR VIEW -->
  <div id="viewYear" class="hidden">
    <div class="sectionTitle">
      <div>
        <span id="yearTitle">–ì–æ–¥</span>
        <div class="sub" id="yearSub"></div>
      </div>
      <span class="badge" id="yearTotalBadge">0</span>
    </div>

    <div class="navLine">
      <button id="prevYear">‚Üê –ì–æ–¥</button>
      <button id="yearToNow">–¢–µ–∫—É—â–∏–π</button>
      <button id="nextYear">–ì–æ–¥ ‚Üí</button>
    </div>

    <div class="chartWrap">
      <div class="chart" id="yearChart"></div>
    </div>
    <small>–¢–∞–ø –ø–æ –º–µ—Å—è—Ü—É ‚Üí –æ—Ç–∫—Ä–æ–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É –º–µ—Å—è—Ü–∞ –∏ —Å—Ä–∞–∑—É –≤–∫–ª–∞–¥–∫—É ‚Äú–ö–∞—Ç–µ–≥–æ—Ä–∏–∏‚Äù.</small>
  </div>
</div>

<!-- MODAL edit -->
<div id="modalBack" class="modalBack hidden">
  <div class="modal">
    <h3>–ó–∞–ø–∏—Å—å</h3>

    <div class="field">
      <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
      <input id="editItem" type="text" placeholder="–∫–æ—Ñ–µ" />
    </div>

    <div class="field">
      <label>–°—É–º–º–∞</label>
      <input id="editAmount" type="number" inputmode="numeric" placeholder="200" />
    </div>

    <div class="field">
      <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
      <input id="editCategory" type="text" disabled />
      <small>–ö–∞—Ç–µ–≥–æ—Ä–∏—è –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî –ø–æ–∑–∂–µ –¥–æ–±–∞–≤–∏–º —Ä—É—á–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ.</small>
    </div>

    <div class="modalActions">
      <button class="cancel" id="btnCancel">–û—Ç–º–µ–Ω–∞</button>
      <button class="del" id="btnDelete">–£–¥–∞–ª–∏—Ç—å</button>
      <button class="save" id="btnSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<script>
/* ===============================
   Voice Cash vNext (single file)
   - 3 views: day / month / year
   - month: days / categories (toggle)
   - year: months -> month categories
   - voice: "–∫–æ—Ñ–µ 200" (auto category) + fallback "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ"
   - edit/delete records
================================= */

/* ---------- CATEGORY RULES (auto) ---------- */
const CATEGORY_RULES = [
  { category: '–ö–æ—Ñ–µ', keywords: ['–∫–æ—Ñ–µ','–ª–∞—Ç—Ç–µ','–∫–∞–ø—É—á–∏–Ω–æ','—ç—Å–ø—Ä–µ—Å—Å–æ','–∞–º–µ—Ä–∏–∫–∞–Ω–æ','—Ä–∞—Ñ','–º–æ–∫–∫–∞','–∫–∞–∫–∞–æ'] },
  { category: '–ï–¥–∞', keywords: ['–µ–¥–∞','—Ä–µ—Å—Ç–æ—Ä–∞–Ω','–∫–∞—Ñ–µ','–æ–±–µ–¥','—É–∂–∏–Ω','–∑–∞–≤—Ç—Ä–∞–∫','—à–∞—É—Ä–º–∞','–ø–∏—Ü—Ü–∞','–±—É—Ä–≥–µ—Ä','—Å—É—à–∏','–ª–∞–ø—à–∞','–∫–µ–±–∞–±','—Ö–ª–µ–±','–º—è—Å–æ','–∫—É—Ä–∏—Ü–∞','—Ä—ã–±–∞','—Å—É–ø','—Å–∞–ª–∞—Ç','–¥–æ—Å—Ç–∞–≤–∫–∞'] },
  { category: '–ü—Ä–æ–¥—É–∫—Ç—ã', keywords: ['–º–∞–≥–∞–∑–∏–Ω','–ø—Ä–æ–¥—É–∫—Ç—ã','–º–∞—Ä–∫–µ—Ç','—Å—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç','–ø—è—Ç–µ—Ä–æ—á–∫–∞','–º–∞–≥–Ω–∏—Ç','lidl','carrefour','—Å–ø–∞—Ä','spar','–∞—à–∞–Ω','auchan'] },
  { category: '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç', keywords: ['—Ç–∞–∫—Å–∏','uber','—è–Ω–¥–µ–∫—Å','–º–µ—Ç—Ä–æ','–∞–≤—Ç–æ–±—É—Å','—Ç—Ä–∞–º–≤–∞–π','–±–µ–Ω–∑–∏–Ω','—Ç–æ–ø–ª–∏–≤–æ','–ø–∞—Ä–∫–æ–≤–∫–∞'] },
  { category: '–°–≤—è–∑—å', keywords: ['–∏–Ω—Ç–µ—Ä–Ω–µ—Ç','—Å–∏–º–∫–∞','—Å–≤—è–∑—å','–º–æ–±–∏–ª—å','—Ç–µ–ª–µ—Ñ–æ–Ω','–ø–æ–ø–æ–ª–Ω','—Ç—Ä–∞—Ñ–∏–∫'] },
  { category: '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è', keywords: ['–∫–∏–Ω–æ','–±–∞—Ä','–∫–ª—É–±','–∏–≥—Ä–∞','–∫–æ–Ω—Ü–µ—Ä—Ç','–∏–≤–µ–Ω—Ç','–≤–µ—á–µ—Ä–∏–Ω–∫–∞'] },
  { category: '–ó–¥–æ—Ä–æ–≤—å–µ', keywords: ['–∞–ø—Ç–µ–∫–∞','–ª–µ–∫–∞—Ä','–≤—Ä–∞—á','–∫–ª–∏–Ω–∏–∫–∞','–∞–Ω–∞–ª–∏–∑','—Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥','–º–∞—Å—Å–∞–∂'] },
];

function detectCategory(rawText){
  const t = (rawText || '').toLowerCase();
  for (const rule of CATEGORY_RULES){
    for (const w of rule.keywords){
      if (t.includes(w)) return rule.category;
    }
  }
  return '–ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ';
}

/* ---------- STORAGE ---------- */
const STORAGE_KEY = 'vc-records-v2';

function loadRecords(){
  try{
    const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    if (!Array.isArray(arr)) return [];
    return arr;
  }catch{
    return [];
  }
}

function saveRecords(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
}

/* ---------- DATE HELPERS ---------- */
const pad2 = n => String(n).padStart(2,'0');
function toISODate(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
function nowISO(){ return toISODate(new Date()); }
function nowTime(){ return new Date().toTimeString().slice(0,5); }
function isoMonth(isoDate){ return isoDate.slice(0,7); }
function isoYear(isoDate){ return isoDate.slice(0,4); }
function monthLabel(monthStr){
  const [y,m] = monthStr.split('-').map(Number);
  const names = ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];
  return `${names[m-1]} ${y}`;
}
function yearLabel(y){ return String(y); }

function startOfMonth(monthStr){
  const [y,m]=monthStr.split('-').map(Number);
  return new Date(y,m-1,1);
}
function daysInMonth(monthStr){
  const [y,m]=monthStr.split('-').map(Number);
  return new Date(y,m,0).getDate();
}
function clamp(n,min,max){ return Math.max(min,Math.min(max,n)); }

/* ---------- STATE ---------- */
let records = loadRecords();

/* migrate older keys if user used previous versions (best-effort) */
(function migrateOld(){
  if (records.length) return;

  // try old keys from previous iterations
  const oldKeys = ['vc-records','vc-records-v1'];
  for (const k of oldKeys){
    try{
      const arr = JSON.parse(localStorage.getItem(k) || '[]');
      if (Array.isArray(arr) && arr.length){
        records = arr.map(r => {
          const date = r.date || nowISO();
          const item = (r.item ?? '').toString();
          const amount = Number(r.amount || 0) || 0;
          const time = r.time || '00:00';
          const category = r.category || detectCategory(item);
          return {
            id: r.id || (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random())),
            item, amount, category,
            date, time,
            ts: r.ts || r.timestamp || Date.now()
          };
        });
        saveRecords();
        return;
      }
    }catch{}
  }
})();

let view = 'day'; // day | month | year
let selectedDate = nowISO();           // for day view
let selectedMonth = isoMonth(selectedDate); // for month view
let selectedYear  = Number(isoYear(selectedDate)); // for year view

let monthTab = 'days'; // days | cats
let monthCatFilter = null; // category name for "cats -> days" drill

/* ---------- ELEMENTS ---------- */
const $ = id => document.getElementById(id);
const btnDay = $('btnDay'), btnMonth = $('btnMonth'), btnYear = $('btnYear');
const viewDay = $('viewDay'), viewMonth = $('viewMonth'), viewYear = $('viewYear');

const sumTodayEl = $('sumToday'), sumMonthEl = $('sumMonth'), sumYearEl = $('sumYear');
const statusEl = $('status');
const recBtn = $('recBtn');

const dayTitleEl = $('dayTitle'), daySubEl = $('daySub'), dayListEl = $('dayList'), dayTotalBadge = $('dayTotalBadge');
const prevDayBtn = $('prevDay'), nextDayBtn = $('nextDay'), toTodayBtn = $('toToday');

const monthTitleEl = $('monthTitle'), monthSubEl = $('monthSub'), monthTotalBadge = $('monthTotalBadge');
const prevMonthBtn = $('prevMonth'), nextMonthBtn = $('nextMonth'), monthToNowBtn = $('monthToNow');
const pillMonthDays = $('pillMonthDays'), pillMonthCats = $('pillMonthCats');
const monthDaysPanel = $('monthDaysPanel'), monthCatsPanel = $('monthCatsPanel'), monthCatDaysPanel = $('monthCatDaysPanel');
const monthChartEl = $('monthChart'), monthCatsEl = $('monthCats');
const monthCatNameEl = $('monthCatName'), monthCatChartEl = $('monthCatChart'), closeMonthCatDays = $('closeMonthCatDays');

const yearTitleEl = $('yearTitle'), yearSubEl = $('yearSub'), yearTotalBadge = $('yearTotalBadge');
const prevYearBtn = $('prevYear'), nextYearBtn = $('nextYear'), yearToNowBtn = $('yearToNow');
const yearChartEl = $('yearChart');

const modalBack = $('modalBack');
const editItem = $('editItem'), editAmount = $('editAmount'), editCategory = $('editCategory');
const btnCancel = $('btnCancel'), btnDelete = $('btnDelete'), btnSave = $('btnSave');

let editingId = null;

/* ---------- VOICE ---------- */
let recognition = null;
let isRecording = false;

recBtn.onclick = () => isRecording ? stopRec() : startRec();

function startRec(){
  if (!('webkitSpeechRecognition' in window)){
    alert('–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ/–±—Ä–∞—É–∑–µ—Ä–µ.');
    return;
  }
  recognition = new webkitSpeechRecognition();
  recognition.lang = 'ru-RU';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  recognition.onresult = e => {
    const text = (e.results?.[0]?.[0]?.transcript || '').toLowerCase().trim();
    parseVoice(text);
  };
  recognition.onend = () => stopRec(true);
  recognition.onerror = () => stopRec(true);

  isRecording = true;
  recBtn.classList.add('recording');
  recBtn.textContent = '‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
  statusEl.textContent = 'üéô –ì–æ–≤–æ—Ä–∏: "–∫–æ—Ñ–µ 200" / "—Ç–∞–∫—Å–∏ 150"';
  recognition.start();
}

function stopRec(silent){
  if (recognition) { try{ recognition.stop(); }catch{} }
  isRecording = false;
  recBtn.classList.remove('recording');
  recBtn.textContent = 'üé§ –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å';
  if (!silent) statusEl.textContent = '';
}

function parseVoice(text){
  statusEl.textContent = `–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: "${text}"`;

  // allow commas/dots
  const cleaned = text.replace(/[,]/g,' ').replace(/\s+/g,' ').trim();

  // Extract last number as amount
  // Examples:
  // "–∫–æ—Ñ–µ 200"
  // "—Ä–µ—Å—Ç–æ—Ä–∞–Ω 1500"
  // "–∫–æ—Ñ–µ –∑–∞ 200" -> item "–∫–æ—Ñ–µ –∑–∞"
  const m = cleaned.match(/^(.*)\s(\d+)\s*$/);
  if (!m){
    statusEl.textContent = '–ù–µ –ø–æ–Ω—è–ª —Å—É–º–º—É. –ü—Ä–∏–º–µ—Ä: "–∫–æ—Ñ–µ 200"';
    return;
  }

  const item = (m[1] || '').trim();
  const amount = parseInt(m[2], 10);

  if (!item || !Number.isFinite(amount) || amount <= 0){
    statusEl.textContent = '–°–∫–∞–∂–∏ —Ç–∞–∫: "–∫–æ—Ñ–µ 200"';
    return;
  }

  const category = detectCategory(item);

  const rec = {
    id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random())),
    item,
    amount,
    category,
    date: nowISO(),
    time: nowTime(),
    ts: Date.now()
  };

  records.unshift(rec);
  saveRecords();

  // after adding new record, show day view for today
  selectedDate = nowISO();
  selectedMonth = isoMonth(selectedDate);
  selectedYear = Number(isoYear(selectedDate));
  setView('day');
  renderAll();
}

/* ---------- VIEW SWITCH ---------- */
btnDay.onclick = () => setView('day');
btnMonth.onclick = () => setView('month');
btnYear.onclick = () => setView('year');

function setActiveButtons(){
  btnDay.classList.toggle('active', view==='day');
  btnMonth.classList.toggle('active', view==='month');
  btnYear.classList.toggle('active', view==='year');
}

function setView(v){
  view = v;
  setActiveButtons();

  viewDay.classList.toggle('hidden', view!=='day');
  viewMonth.classList.toggle('hidden', view!=='month');
  viewYear.classList.toggle('hidden', view!=='year');

  if (view==='month'){
    // default month tab:
    // - if user came from year click -> we will set monthTab to 'cats' there
    // - else keep current monthTab
    applyMonthTab(monthTab);
  }
  renderAll();
}

/* ---------- DAY NAV ---------- */
prevDayBtn.onclick = () => shiftDay(-1);
nextDayBtn.onclick = () => shiftDay(+1);
toTodayBtn.onclick = () => { selectedDate = nowISO(); renderAll(); };

function shiftDay(delta){
  const d = new Date(selectedDate+'T00:00:00');
  d.setDate(d.getDate()+delta);
  selectedDate = toISODate(d);
  // keep month/year in sync for convenience
  selectedMonth = isoMonth(selectedDate);
  selectedYear = Number(isoYear(selectedDate));
  renderAll();
}

/* ---------- MONTH NAV ---------- */
prevMonthBtn.onclick = () => shiftMonth(-1);
nextMonthBtn.onclick = () => shiftMonth(+1);
monthToNowBtn.onclick = () => { selectedMonth = isoMonth(nowISO()); renderAll(); };

function shiftMonth(delta){
  const d = startOfMonth(selectedMonth);
  d.setMonth(d.getMonth()+delta);
  selectedMonth = `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
  selectedYear = d.getFullYear();
  monthCatFilter = null;
  monthCatDaysPanel.classList.add('hidden');
  renderAll();
}

/* ---------- YEAR NAV ---------- */
prevYearBtn.onclick = () => { selectedYear -= 1; renderAll(); };
nextYearBtn.onclick = () => { selectedYear += 1; renderAll(); };
yearToNowBtn.onclick = () => { selectedYear = Number(isoYear(nowISO())); renderAll(); };

/* ---------- MONTH TABS ---------- */
pillMonthDays.onclick = () => applyMonthTab('days');
pillMonthCats.onclick = () => applyMonthTab('cats');

  
